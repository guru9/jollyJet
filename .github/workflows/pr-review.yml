#phase 4
name: Pull Request Review Environment

# Pull Request Review Environment Automation
# This workflow creates temporary review environments for pull requests to
# facilitate testing and review. It builds a review image, deploys it, and
# provides a preview URL for team members to test changes.

# Triggers:
# - Pull request opened
# - Pull request synchronized (new commits pushed)
# - Pull request reopened

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '22'
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: jollyjet-starter
  REVIEW_ENVIRONMENT: review-${{ github.sha }}

jobs:
  # Step 1: Build Review Docker Image
  # This job builds a temporary Docker image for PR review
  build-review-image:
    name: Build Review Docker Image
    runs-on: ubuntu-latest

    steps:
      # Step 1.1: Checkout the PR branch code to the runner
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      # Step 1.2: Set up Docker Buildx for multi-platform builds
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 1.3: Build the review image with PR-specific labels
      - name: Build review image
        uses: docker/build-push-action@v5
        with:
          context: .
          dockerfile: docker/Dockerfile
          push: false
          tags: ${{ env.REVIEW_ENVIRONMENT }}
          labels: |
            org.opencontainers.image.source=${{ github.event.pull_request.head.repo.html_url }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.pull_request.created_at }}

      # Step 1.4: Upload build artifacts for reference
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: review-build-artifacts
          path: |
            docker/Dockerfile
            docker/docker-compose.yml
          retention-days: 3

  # Step 2: Deploy Review Environment
  # This job deploys the review image to a temporary environment
  deploy-review-environment:
    name: Deploy Review Environment
    runs-on: ubuntu-latest
    needs: build-review-image

    steps:
      # Step 2.1: Checkout the PR branch code to the runner
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      # Step 2.2: Setup Docker Compose to manage containers
      - name: Setup Docker Compose
        uses: docker/setup-compose-action@v2

      # Step 2.3: Run the review environment container
      - name: Deploy review environment
        run: |
          docker run -d -p 3000:3000 ${{ env.REVIEW_ENVIRONMENT }}
          sleep 30

      # Step 2.4: Perform health check on the review environment
      - name: Health check
        run: |
          curl -f http://localhost:3000/health

      # Step 2.5: Generate preview URL for PR review
      - name: Generate preview URL
        run: |
          REVIEW_URL="http://localhost:3000"
          echo "::set-output name=preview_url::$REVIEW_URL"

      # Step 2.6: Show deployment status and services
      - name: Show deployment status
        run: |
          echo "üöÄ Review environment deployed successfully!"
          echo "üìä Services status:"
          docker ps -a

      # Step 2.7: Show recent container logs for debugging
      - name: Show logs
        run: |
          echo "üìù Recent logs:"
          docker logs $(docker ps -q --filter ancestor=${{ env.REVIEW_ENVIRONMENT }})

      # Step 2.8: Save deployment artifacts
      - name: Save review artifacts
        uses: actions/upload-artifact@v4
        with:
          name: review-deployment-artifacts
          path: |
            review-deployment.log
            preview-url.txt
          retention-days: 3

  # Step 3: Comment Preview URL
  # This job comments the preview URL on the PR
  comment-preview-url:
    name: Comment Preview URL
    runs-on: ubuntu-latest
    needs: deploy-review-environment

    steps:
      # Step 3.1: Download the review deployment artifacts
      - name: Get preview URL
        uses: actions/download-artifact@v4
        with:
          name: review-deployment-artifacts
          path: artifacts

      # Step 3.2: Read the preview URL from the artifact
      - name: Read preview URL
        id: preview
        run: |
          PREVIEW_URL=$(cat artifacts/preview-url.txt)
          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT

      # Step 3.3: Comment the preview URL on the PR
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const { preview_url } = ${{ toJSON(steps.preview.outputs) }};
            const { owner, repo, number } = context.issue;

            const body = `## Review Environment Deployed\n\n` +
                        `üöÄ **Preview URL:** ${preview_url}\n\n` +
                        `üìù **Commit:** ${context.sha.substring(0, 7)}\n` +
                        `üë• **Author:** ${context.actor}\n\n` +
                        `### Quick Actions\n\n` +
                        `- [ ] Review the changes\n` +
                        `- [ ] Test the preview\n` +
                        `- [ ] Approve if ready\n` +
                        `- [ ] Request changes if needed\n\n` +
                        `---\n\n` +
                        `*This environment will be automatically cleaned up after 3 days or when the PR is closed.*`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body,
            });

  # Step 4: Cleanup Review Environment
  # This job cleans up the review environment when PR is closed or updated
  cleanup-review-environment:
    name: Cleanup Review Environment
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && (github.event.action == 'closed' || github.event.action == 'synchronize')

    steps:
      # Step 4.1: Cleanup Docker resources
      - name: Cleanup Docker resources
        run: |
          echo "üßπ Cleaning up review environment..."
          docker stop $(docker ps -q --filter ancestor=${{ env.REVIEW_ENVIRONMENT }}) && docker rm $(docker ps -aq --filter ancestor=${{ env.REVIEW_ENVIRONMENT }})
          docker rmi ${{ env.REVIEW_ENVIRONMENT }} || true

      # Step 4.2: Delete the review deployment artifacts
      - name: Cleanup artifacts
        uses: actions/delete-artifact@v4
        with:
          name: review-deployment-artifacts

      # Step 4.3: Comment on PR about cleanup
      - name: Comment cleanup
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body: '## Review Environment Cleaned Up\n\n' +
                    'üßπ The review environment has been automatically cleaned up.\n\n' +
                    '' +
                    'This cleanup was triggered because the PR was closed or synchronized.\n',
            });
