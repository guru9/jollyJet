name: Testing and Quality Gates

# Comprehensive Testing Pipeline with Quality Gates
# This workflow runs all types of tests and enforces quality gates for the
# JollyJet application. It includes unit tests, integration tests, E2E tests,
# performance tests, security tests, accessibility tests, and coverage checks.

# Triggers:
# - Push to main or develop branches
# - Pull requests to main branch
# - Manual workflow dispatch

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '22'
  TEST_FRAMEWORK: jest
  COVERAGE_THRESHOLD: 80

jobs:
  code-quality-gates:
    name: Code Quality Gates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint with custom rules
        run: |
          npx eslint . --ext .ts,.js --max-warnings=0 --no-error-on-unmatched-pattern

      - name: Check Prettier formatting
        run: |
          npx prettier --check "./{src,tests}/**/*.{ts,js,json}" --no-error-on-unmatched-pattern

      - name: TypeScript compilation check
        run: |
          npx tsc --noEmit --skipLibCheck

      - name: Security code scan
        uses: github/codeql-action/analyze@v2

      - name: Upload quality gate results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: quality-gate-results
          path: |
            eslint.log
            prettier.log
            tsc.log
          retention-days: 7

  unit-tests-matrix:
    name: Unit Tests (Matrix)
    runs-on: ubuntu-latest
    needs: code-quality-gates
    strategy:
      matrix:
        node-version: [22]
        test-type: [unit, integration]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ${{ matrix.test-type }} tests
        run: |
          if [ "${{ matrix.test-type }}" = "unit" ]; then
            npm run test:unit
          else
            npm run test:integration
          fi
        env:
          NODE_ENV: test
          MONGODB_URI: mongodb://localhost:27017/jollyjet-test
          REDIS_URL: redis://localhost:6379

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: ${{ matrix.test-type }}-test-results-${{ matrix.node-version }}
          path: junit.xml
          retention-days: 7

  integration-tests-services:
    name: Integration Tests with Services
    runs-on: ubuntu-latest
    needs: unit-tests-matrix
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        options: --health-cmd="mongo" --health-interval=10s --health-timeout=5s --health-retries=5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run integration tests
        run: npm run test:integration
        env:
          NODE_ENV: test
          MONGODB_URI: mongodb://localhost:27017/jollyjet-test
          REDIS_URL: redis://localhost:6379

      - name: Upload integration test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: integration-test-results
          path: integration-test-results.xml
          retention-days: 7

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: integration-tests-services

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup test environment
        run: |
          docker compose -f docker/docker-compose.e2e.yml up -d
          sleep 30

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          NODE_ENV: test
          API_BASE_URL: http://localhost:3000

      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-test-results
          path: e2e-test-results.xml
          retention-days: 7

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: e2e-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup performance test environment
        run: |
          docker compose -f docker/docker-compose.performance.yml up -d
          sleep 60

      - name: Run performance tests
        run: npm run test:performance
        env:
          NODE_ENV: test
          API_BASE_URL: http://localhost:3000

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: performance-results.json
          retention-days: 7

  coverage-reporting:
    name: Coverage Reporting
    runs-on: ubuntu-latest
    needs: [unit-tests-matrix, integration-tests-services, e2e-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate coverage report
        run: npm run test:coverage
        env:
          NODE_ENV: test

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Check coverage thresholds
        run: |
          COVERAGE=$(npx jest --coverage --coverageReporters=json | grep -o '"global":{"branches":[0-9.]*' | grep -o '[0-9.]*$')
          THRESHOLD=${{ env.COVERAGE_THRESHOLD }}
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "::error::Coverage ($COVERAGE%) below threshold ($THRESHOLD%)"
            exit 1
          fi
          echo "Coverage ($COVERAGE%) meets threshold ($THRESHOLD%)"

  security-testing:
    name: Security Testing
    runs-on: ubuntu-latest
    needs: coverage-reporting

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Snyk security test
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: Run OWASP ZAP baseline scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'

      - name: Run dependency vulnerability scan
        run: |
          npm audit --audit-level=moderate

      - name: Upload security scan results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: security-scan-results
          path: security-scan-results.json
          retention-days: 30

  accessibility-testing:
    name: Accessibility Testing
    runs-on: ubuntu-latest
    needs: security-testing

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run accessibility tests
        run: npm run test:accessibility
        env:
          NODE_ENV: test
          API_BASE_URL: http://localhost:3000

      - name: Upload accessibility results
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-results
          path: accessibility-results.json
          retention-days: 30

  quality-gate-decision:
    name: Quality Gate Decision
    runs-on: ubuntu-latest
    needs:
      [
        code-quality-gates,
        unit-tests-matrix,
        integration-tests-services,
        e2e-tests,
        coverage-reporting,
        security-testing,
        accessibility-testing,
      ]

    steps:
      - name: Check quality gate status
        run: |
          # Check if any previous jobs failed
          if [[ "${{ needs.code-quality-gates.result }}" == "failure" || \
                "${{ needs.unit-tests-matrix.result }}" == "failure" || \
                "${{ needs.integration-tests-services.result }}" == "failure" || \
                "${{ needs.e2e-tests.result }}" == "failure" || \
                "${{ needs.coverage-reporting.result }}" == "failure" || \
                "${{ needs.security-testing.result }}" == "failure" || \
                "${{ needs.accessibility-testing.result }}" == "failure" ]]; then
            echo "::error::Quality gates failed"
            exit 1
          fi
          echo "Quality gates passed"

      - name: Generate quality report
        run: |
          echo "Quality Report:" > quality-report.md
          echo "================" >> quality-report.md
          echo "" >> quality-report.md
          echo "Code Quality: ${{ needs.code-quality-gates.result }}" >> quality-report.md
          echo "Unit Tests: ${{ needs.unit-tests-matrix.result }}" >> quality-report.md
          echo "Integration Tests: ${{ needs.integration-tests-services.result }}" >> quality-report.md
          echo "E2E Tests: ${{ needs.e2e-tests.result }}" >> quality-report.md
          echo "Coverage: ${{ needs.coverage-reporting.result }}" >> quality-report.md
          echo "Security: ${{ needs.security-testing.result }}" >> quality-report.md
          echo "Accessibility: ${{ needs.accessibility-testing.result }}" >> quality-report.md

      - name: Upload quality report
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: quality-report.md
          retention-days: 30
